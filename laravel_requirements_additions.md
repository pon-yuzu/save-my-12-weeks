# Laravel要件定義書 - 追加項目

以下の項目を既存の要件定義書に追加してください。

---

## 追加1: 30日講座の配信時間選択機能

### 概要
ユーザーがメルマガ登録時に、30日講座の配信時間を選択できる機能。

### フロー
```
診断完了 → 追加質問 → メアド入力 → 配信時間選択 → 登録完了
```

### 選択肢
| 時間 | 表示テキスト |
|------|-------------|
| 06:00 | 朝6時（早起き派） |
| 08:00 | 朝8時（通勤前） |
| 12:00 | お昼12時（ランチタイム） |
| 18:00 | 夕方6時（仕事終わり） |
| 21:00 | 夜9時（寝る前） |

### データベース変更
**mail_subscriptions テーブルに追加**
| カラム | 型 | 説明 |
|--------|-----|------|
| preferred_time | time | 希望配信時間（デフォルト: 08:00） |

### 配信ロジック
- 毎日、各時間帯ごとにキューを実行
- ユーザーの `preferred_time` に基づいて配信

---

## 追加2: Day 14.5（折り返しメール）

### 概要
30日講座の折り返し地点で、目標のアップデートを促す追加メール。

### 配信タイミング
- Day 14の**夜9時**に配信（通常のDayメールとは別）
- Day 14のメールが配信された後

### 配信条件
- ユーザーの `preferred_time` に関係なく、全員21:00に配信
- Day 14まで継続している人のみ対象

### データベース変更
**mail_logs テーブルの mail_type に追加**
```
enum: 30day_course, 30day_course_halfway, seminar_reminder, ...
```

### メール内容
- Week 1の目標を見返すよう促す
- 「本当はもっとこうなりたい」を書き換えてもらう
- 来週からSMARTで具体化することを予告

---

## 追加3: Google Calendar連携（予約システム強化）

### 概要
個人セッション予約とセミナー日程管理をGoogle Calendarと連携。

### 機能

#### 3-1. 空き枠の自動判定
- SayakaのGoogle Calendarを参照
- 既存予定がある時間帯は予約不可として表示
- 管理画面で登録した空き枠 × カレンダー空き = 実際の予約可能枠

#### 3-2. 予約完了時の自動登録
- ユーザーが予約完了 → SayakaのGoogle Calendarに予定を自動追加
- イベントタイトル例：「【個人セッション】${user_name}さん」
- Zoom URLも自動生成して含める（Zoom API連携オプション）

#### 3-3. セミナー日程の連携
- 管理画面でセミナー日程を登録 → Google Calendarにも追加
- メールテンプレートの `${seminar_date}` に自動反映

### 技術要件
- Google Calendar API（OAuth 2.0）
- サービスアカウントまたはOAuth認証
- Laravel socialite + Google API Client

### データベース変更
**available_slots テーブルに追加**
| カラム | 型 | 説明 |
|--------|-----|------|
| google_event_id | varchar(255) | Google CalendarのイベントID（連携時） |

**session_bookings テーブルに追加**
| カラム | 型 | 説明 |
|--------|-----|------|
| google_event_id | varchar(255) | 作成されたカレンダーイベントID |
| zoom_url | varchar(255) | Zoom URL（自動生成時） |

---

## 追加4: 30日講座のWeek構成修正

### 現行の正しい構成
要件定義書の「7. 30日講座の構成」を以下に置き換え：

| 週 | フェーズ | 内容 | フレームワーク |
|---|---------|------|---------------|
| Week 1 (Day 1-5) | T（Theme） | 現状把握、気になる項目、どう変えたい | ライフウィール + T-GROWのT |
| Day 6-7 | 週末① | 不安解消 + モチベ | - |
| Week 2 (Day 8-12) | 夢見ていい | ブロック外し、Sayakaの体験、方法は後から | マインドセット転換 |
| Day 13-14 | 週末② | 不安解消 + モチベ | - |
| Day 14.5 | 折り返し | 目標アップデート促進 | - |
| Week 3 (Day 15-19) | G（Goal） | SMARTで具体化 | SMARTゴール |
| Day 20-21 | 週末③ | 不安解消 + モチベ | - |
| Week 4 (Day 22-26) | R（Reasons） | なぜ大事か、やらなかったら？ | T-GROWのR |
| Day 27-28 | 週末④ | 不安解消 + モチベ | - |
| Day 29-30 | まとめ | 振り返り + 次のステップ紹介 | 1ヶ月前との比較 |

### 講座後の導線
- Day 30で T-GROWの O（Options）・W（Way Forward）はセッションで、と案内
- 個人セッション予約ページへ誘導

---

## 追加5: メールのパーソナライゼーション

### 使用する変数
| 変数名 | 取得元 | 説明 |
|--------|--------|------|
| ${name} | users.name | ユーザー名 |
| ${areas_to_change} | diagnosis_results.areas_to_change | 診断で選んだ「変えたい項目」 |
| ${next_seminar_date} | seminars（is_current=true） | 次回セミナー日程 |
| ${seminar_application_url} | 設定値 | セミナー申込URL |
| ${booking_url} | 設定値 | 個別相談予約URL |
| ${unsubscribe_url} | 動的生成 | 配信停止URL（トークン付き） |

### 実装方法
- Bladeテンプレートまたはメール本文にプレースホルダーを配置
- 送信時にユーザーデータで置換
- `areas_to_change` はJSON配列なので、日本語ラベルに変換して表示
  - 例：`["health", "time"]` → 「健康・体」「自分の時間」

---

## 追加6: 今後の検討事項（更新）

以下を「9. 今後の検討事項」に追加：

- [x] 30日講座の配信時間選択機能
- [x] Day 14.5（折り返しメール）
- [x] 30日講座の各Day本文作成 → **完了**（別途ファイル参照）
- [ ] Google Calendar連携の実装
- [ ] Zoom API連携（自動URL生成）
- [ ] 開封率トラッキング
- [ ] セミナー参加/不参加のトラッキング
- [ ] 30日講座完了後のフォローメール設計
